<html lang="pl">
<head>
  <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiIiwic2hvcnRfbmFtZSI6IiIsInRoZW1lX2NvbG9yIjoiIzEwMTMxNyIsImJhY2tncm91bmRfY29sb3IiOiIjMTAxMzE3IiwiZGlzcGxheSI6InN0YW5kYWxvbmUifQ==">
  <base href="/dowodplska/">
  <title>mObywatel</title>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="format-detection" content="telephone=no">
  <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="assets/app/main.css">
  <link rel="stylesheet" href="assets/app/card.css">
  <link rel="icon" type="image/x-icon" href="assets/app/images/ikonka.png">
  <link rel="apple-touch-icon" href="assets/app/images/ikonka.png">
  <link rel="shortcut icon" href="assets/app/images/ikonka.png">
</head>
<body>

  <div class="top_grid_fixed">
    <div class="action_grid_fixed">
      <img src="assets/app/images/back_blue.png" class="back_img_fixed" alt="">
      <p onclick="sendTo('documents.html')" class="back_text_fixed">Wróć</p>
    </div>
    <p class="title_text_fixed">mDowód</p>
    <img src="assets/app/images/help.png" class="help_img_fixed" alt="">
  </div>

  <div class="bottom_bar">
    <div class="bottom_bar_grid">
      <div class="bottom_element_grid" send="documents.html">
        <div class="bottom_element_image documents_open"></div>
        <p class="bottom_element_text open">Dokumenty</p>
      </div>
      <div class="bottom_element_grid" send="services.html">
        <div class="bottom_element_image services"></div>
        <p class="bottom_element_text">Usługi</p>
      </div>
      <div class="bottom_element_grid" send="qr.html">
        <div class="bottom_element_image qr"></div>
        <p class="bottom_element_text">Kod QR</p>
      </div>
      <div class="bottom_element_grid" send="more.html">
        <div class="bottom_element_image more"></div>
        <p class="bottom_element_text">Więcej</p>
      </div>
    </div>
  </div>

  <div class="container">
    <p class="time_text" id="time">Czas: 01:28:22 27.10.2025</p>

    <div class="id_wrapper">
      <div class="id_image_data">
        <img draggable="false" class="id_image" src="assets/app/images/plate.png" alt="">
        <div class="inset"></div>

        <div class="id_own_image" id="userPhoto" style="background-image:url('assets/app/images/blank.png');"></div>

        <img draggable="false" src="assets/app/images/flag.webp" class="flag_video" alt="">
        <img draggable="false" src="assets/app/images/eagle.png" class="eagle_video" alt="">
        <p class="eagle_text">Rzeczpospolita<br>Polska</p>

        <div class="id_data_grid">
          <div class="data_holder">
            <p class="data_title firstname" id="name"></p>
            <p class="data_value">Imię (imiona)</p>
          </div>
          <div class="data_holder">
            <p class="data_title surname" id="surname"></p>
            <p class="data_value">Nazwisko</p>
          </div>
          <div class="data_holder">
            <p class="data_title" id="nationality"></p>
            <p class="data_value">Obywatelstwo</p>
          </div>
          <div class="data_holder">
            <p class="data_title" id="birthday"></p>
            <p class="data_value">Data urodzenia</p>
          </div>
          <div class="data_holder">
            <p class="data_title" id="pesel_value"></p>
            <p class="data_value">Numer PESEL</p>
          </div>
        </div>
      </div>

      <div class="id_bottom">
        <div class="bottom_grid">
          <img class="bottom_image" src="assets/app/images/valid.png" alt="">
          <p class="bottom_text" style="color:#16be2d;font-weight:600;font-size:16px;margin-left:15px;">Dokument ważny</p>
        </div>
      </div>
    </div>

    <div class="under_container">
      <div class="under_grid">
        <div class="under_icon" onclick="sendTo('scan.html', 'card.html')">
          <div class="under_image_circle">
            <img class="under_image" src="assets/app/images/confirm.png" alt="">
          </div>
          <p class="under_text">Potwierdź swoje dane</p>
        </div>
        <div class="under_icon" onclick="sendTo('document.html')">
          <div class="under_image_circle">
            <img class="under_image" src="assets/app/images/id_data.png" alt="">
          </div>
          <p class="under_text">Dane dowodu osobistego</p>
        </div>
        <div class="under_icon" onclick="sendTo('pesel.html')">
          <div class="under_image_circle">
            <img class="under_image" src="assets/app/images/lock.png" alt="">
          </div>
          <p class="under_text">Zastrzeż PESEL</p>
        </div>
        <div class="under_icon" onclick="sendTo('shortcuts.html')">
          <div class="under_image_circle">
            <img class="under_image" src="assets/app/images/more.png" alt="">
          </div>
          <p class="under_text">Pozostałe skróty</p>
        </div>
      </div>
    </div>

    <div class="confirm_info">
      <div class="confirm_box">
        <p class="box_top">Seria i numer mDowodu</p>
        <p class="box_value box_highlight" id="seriesAndNumber"></p>
        <button class="main_button_filled" onclick="navigator.clipboard.writeText(document.getElementById('seriesAndNumber').textContent)">Kopiuj</button>
        <p class="box_description">Dane mDowodu i dowodu osobistego są inne - to dwa różne dokumenty.</p>
      </div>
      <div class="confirm_box">
        <p class="box_top">Termin ważności</p>
        <p class="box_value" id="expiryDate"></p>
      </div>
      <div class="confirm_box">
        <p class="box_top">Data wydania</p>
        <p class="box_value" id="givenDate"></p>
      </div>
      <div class="confirm_box">
        <p class="box_top">Imię ojca</p>
        <p class="box_value" id="fathersName"></p>
      </div>
      <div class="confirm_box" style="border:none;">
        <p class="box_top">Imię matki</p>
        <p class="box_value" id="mothersName"></p>
      </div>
    </div>

    <div class="other_grid">
      <div class="bottom_holder info_holder">
        <div class="bottom_grid">
          <p class="bottom_text" style="margin-left:0px;">Twoje dodatkowe dane</p>
        </div>
        <img class="action_arrow" src="assets/app/images/arrow_white.png" alt="">
        <div class="additional_holder">
          <div class="additional_grid">
            <p class="additional_title">Nazwisko rodowe</p>
            <p class="additional_subtitle" id="familyName"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Płeć</p>
            <p class="additional_subtitle" id="sex"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Nazwisko rodowe ojca</p>
            <p class="additional_subtitle" id="fathersFamilyName"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Nazwisko rodowe matki</p>
            <p class="additional_subtitle" id="mothersFamilyName"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Miejsce urodzenia</p>
            <p class="additional_subtitle" id="birthPlace"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Kraj urodzenia</p>
            <p class="additional_subtitle" id="countryOfBirth"></p>
          </div>
          <div class="additional_grid">
            <p class="additional_title">Adres zameldowania na pobyt stały</p>
            <p class="additional_subtitle" id="adress"></p>
          </div>
          <div class="additional_grid" style="border-bottom:none;margin-bottom:0px;">
            <p class="additional_title">Data zameldowania na pobyt stały</p>
            <p class="additional_subtitle home_date" id="homeDate"></p>
          </div>
        </div>
      </div>

      <div class="bottom_holder" style="height:95px;margin-bottom:130px;">
        <div class="bottom_update">
          <div class="bottom_update_grid">
            <p class="bottom_update_text" style="margin-left:0px;">Ostatnia aktualizacja</p>
            <p class="bottom_update_value" id="updateDate" style="margin-left:0px;"></p>
          </div>
          <button class="main_button_filled update" style="right:20px;" onclick="location.reload()">Aktualizuj</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/app/encode.js"></script>
  <script src="assets/app/bar.js"></script>
  <script src="assets/app/card.js"></script>
  <script src="assets/app/manifest.js"></script>
  <script src="assets/app/cache.js"></script>

  <script>
    // === Funkcje pomocnicze do generowania danych ===
    function generatePesel(day, month, year, sex) {
      const d = day.toString().padStart(2, '0');
      let m = month;
      if (year >= 2000) m = month + 20;
      m = m.toString().padStart(2, '0');
      const y = year.toString().slice(-2);
      const random = Math.floor(Math.random() * 900) + 100;
      let lastDigit = Math.floor(Math.random() * 10);
      if (sex === 'k' && lastDigit % 2 !== 0) lastDigit = (lastDigit + 1) % 10;
      if (sex === 'm' && lastDigit % 2 === 0) lastDigit = (lastDigit + 1) % 10;
      return `${y}${m}${d}${random}${lastDigit}`;
    }

    function generateSeriesAndNumber() {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      const serie = letters[Math.floor(Math.random() * letters.length)] + 
                    letters[Math.floor(Math.random() * letters.length)] + 
                    letters[Math.floor(Math.random() * letters.length)];
      const number = Math.floor(Math.random() * 900000) + 100000;
      return `${serie} ${number}`;
    }

    function generateGivenDate() {
      const now = new Date();
      const daysAgo = Math.floor(Math.random() * 365 * 3);
      const givenDate = new Date(now.getTime() - daysAgo * 24 * 60 * 60 * 1000);
      return givenDate.toLocaleDateString('pl-PL');
    }

    function generateExpiryDate(givenDateStr) {
      const parts = givenDateStr.split('.');
      const givenDate = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
      const expiryDate = new Date(givenDate);
      expiryDate.setFullYear(givenDate.getFullYear() + 10);
      return expiryDate.toLocaleDateString('pl-PL');
    }

    function generateHomeDate() {
      const now = new Date();
      const daysAgo = Math.floor(Math.random() * 365 * 10) + 365;
      const homeDate = new Date(now.getTime() - daysAgo * 24 * 60 * 60 * 1000);
      return homeDate.toLocaleDateString('pl-PL');
    }

    // === Funkcje do obsługi IndexedDB ===
    function getDb() {
      return new Promise((resolve, reject) => {
        const r = indexedDB.open('fobywatel', 1);
        r.onupgradeneeded = e => {
          const db = e.target.result;
          if (!db.objectStoreNames.contains('data')) {
            db.createObjectStore('data', { keyPath: 'data' });
          }
        };
        r.onsuccess = e => resolve(e.target.result);
        r.onerror = e => reject(e.target.error);
      });
    }

    function getData(db, key) {
      return new Promise((resolve, reject) => {
        const tx = db.transaction('data', 'readonly');
        const store = tx.objectStore('data');
        const req = store.get(key);
        req.onsuccess = () => resolve(req.result);
        req.onerror = e => reject(e.target.error);
      });
    }

    // === Główna funkcja wczytywania danych ===
    (async function loadData() {
      try {
        // Sprawdź najpierw parametry URL
        const params = new URLSearchParams(window.location.search);
        
        // Jeśli są parametry URL, użyj ich
        if (params.toString()) {
          const fields = [
            'name','surname','nationality','birthday','pesel_value','seriesAndNumber','expiryDate',
            'givenDate','fathersName','mothersName','familyName','sex','fathersFamilyName',
            'mothersFamilyName','birthPlace','countryOfBirth','adress','homeDate','updateDate'
          ];
          
          fields.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            let value = params.get(id);
            if (value) {
              el.textContent = value;
              // Zapisz do localStorage jako backup
              localStorage.setItem(id, value);
            }
          });
          
          // Sprawdź zdjęcie z URL
          const photoUrl = params.get('image');
          if (photoUrl) {
            document.getElementById('userPhoto').style.backgroundImage = `url(${photoUrl})`;
            localStorage.setItem('userPhoto', photoUrl);
          }
          
          return; // Zakończ, jeśli dane są z URL
        }

        // Jeśli nie ma URL, sprawdź localStorage
        const fields = [
          'name','surname','nationality','birthday','pesel_value','seriesAndNumber','expiryDate',
          'givenDate','fathersName','mothersName','familyName','sex','fathersFamilyName',
          'mothersFamilyName','birthPlace','countryOfBirth','adress','homeDate','updateDate'
        ];
        
        let foundInLocalStorage = false;
        fields.forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          let value = localStorage.getItem(id);
          if (value) {
            el.textContent = value;
            foundInLocalStorage = true;
          }
        });
        
        const photo = localStorage.getItem('userPhoto');
        if (photo) {
          document.getElementById('userPhoto').style.backgroundImage = `url(${photo})`;
          foundInLocalStorage = true;
        }

        // Jeśli znaleziono w localStorage, zakończ
        if (foundInLocalStorage) return;

        // Ostatnia opcja: spróbuj wczytać z IndexedDB
        const db = await getDb();
        const userData = await getData(db, 'data');
        
        if (userData) {
          // Formatuj datę urodzenia
          const birthday = `${userData.day.toString().padStart(2, '0')}.${userData.month.toString().padStart(2, '0')}.${userData.year}`;
          
          // Generuj dodatkowe dane jeśli nie istnieją
          if (!localStorage.getItem('pesel_value')) {
            const pesel = generatePesel(userData.day, userData.month, userData.year, userData.sex);
            localStorage.setItem('pesel_value', pesel);
          }
          
          if (!localStorage.getItem('seriesAndNumber')) {
            const seriesAndNumber = generateSeriesAndNumber();
            localStorage.setItem('seriesAndNumber', seriesAndNumber);
          }
          
          if (!localStorage.getItem('givenDate')) {
            const givenDate = generateGivenDate();
            localStorage.setItem('givenDate', givenDate);
          }
          
          if (!localStorage.getItem('expiryDate')) {
            const givenDate = localStorage.getItem('givenDate');
            const expiryDate = generateExpiryDate(givenDate);
            localStorage.setItem('expiryDate', expiryDate);
          }
          
          if (!localStorage.getItem('homeDate')) {
            const homeDate = generateHomeDate();
            localStorage.setItem('homeDate', homeDate);
          }
          
          if (!localStorage.getItem('updateDate')) {
            const updateDate = new Date().toLocaleDateString('pl-PL');
            localStorage.setItem('updateDate', updateDate);
          }
          
          // Formatuj adres
          const adress = `UL. ${userData.address1}\n${userData.address2} ${userData.city}`.toUpperCase();
          
          // Ustaw wszystkie dane
          document.getElementById('name').textContent = userData.name.toUpperCase();
          document.getElementById('surname').textContent = userData.surname.toUpperCase();
          document.getElementById('nationality').textContent = userData.nationality.toUpperCase();
          document.getElementById('birthday').textContent = birthday;
          document.getElementById('pesel_value').textContent = localStorage.getItem('pesel_value');
          document.getElementById('seriesAndNumber').textContent = localStorage.getItem('seriesAndNumber');
          document.getElementById('expiryDate').textContent = localStorage.getItem('expiryDate');
          document.getElementById('givenDate').textContent = localStorage.getItem('givenDate');
          document.getElementById('fathersName').textContent = userData.fathersName.toUpperCase();
          document.getElementById('mothersName').textContent = userData.mothersName.toUpperCase();
          document.getElementById('familyName').textContent = userData.familyName.toUpperCase();
          document.getElementById('sex').textContent = (userData.sex === 'm' ? 'MĘŻCZYZNA' : 'KOBIETA');
          document.getElementById('fathersFamilyName').textContent = userData.fathersFamilyName.toUpperCase();
          document.getElementById('mothersFamilyName').textContent = userData.mothersFamilyName.toUpperCase();
          document.getElementById('birthPlace').textContent = userData.birthPlace.toUpperCase();
          document.getElementById('countryOfBirth').textContent = userData.countryOfBirth.toUpperCase();
          document.getElementById('adress').innerHTML = adress.replace('\n', '<br>');
          document.getElementById('homeDate').textContent = localStorage.getItem('homeDate');
          document.getElementById('updateDate').textContent = localStorage.getItem('updateDate');
          
          // Zapisz do localStorage
          localStorage.setItem('name', userData.name);
          localStorage.setItem('surname', userData.surname);
          localStorage.setItem('nationality', userData.nationality);
          localStorage.setItem('birthday', birthday);
          localStorage.setItem('fathersName', userData.fathersName);
          localStorage.setItem('mothersName', userData.mothersName);
          localStorage.setItem('familyName', userData.familyName);
          localStorage.setItem('sex', userData.sex === 'm' ? 'MĘŻCZYZNA' : 'KOBIETA');
          localStorage.setItem('fathersFamilyName', userData.fathersFamilyName);
          localStorage.setItem('mothersFamilyName', userData.mothersFamilyName);
          localStorage.setItem('birthPlace', userData.birthPlace);
          localStorage.setItem('countryOfBirth', userData.countryOfBirth);
          localStorage.setItem('adress', adress);
        }
        
        // Pobierz zdjęcie z IndexedDB
        const imageData = await getData(db, 'image');
        if (imageData && imageData.image) {
          document.getElementById('userPhoto').style.backgroundImage = `url(${imageData.image})`;
          localStorage.setItem('userPhoto', imageData.image);
        }
        
      } catch (error) {
        console.error('Błąd wczytywania danych:', error);
      }
    })();
  </script>
</body>
</html>